<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>ALPHA-g Data Handler</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
		<style>
			.btn-close {
				font-size: 0.6rem;
				width: 0.75rem;
				height: 0.75rem;
				padding: 0.15rem;
			}
		</style>
	</head>

	<body>
		<nav class="navbar bg-body-tertiary">
			<div class="container">
				<a class="navbar-brand" href="/">ALPHA-g Data Handler</a>
				<div class="d-flex">
					<input class="form-control me-2" type="search" placeholder="Run number" id="search-input">
					<button class="btn btn-outline-success" id="load-button">Load</button>
				</div>
			</div>
		</nav>

		<div class="container mt-5">
			<h1 class="mb-4">Run {{ run_number }}</h1>
			<div class="row">
				<div class="col-md-6">
					<div class="card">
						<div class="card-body">
							<h5 class="card-title">Start Time</h5>
							<p class="card-text">{{ start_time }}</p>
						</div>
					</div>
				</div>
				<div class="col-md-6">
					<div class="card">
						<div class="card-body">
							<h5 class="card-title">Stop Time</h5>
							<p class="card-text">{{ stop_time }}</p>
						</div>
					</div>
				</div>
			</div>
			<div class="row mt-4">
				<div class="col-md-12">
					<div class="card">
						<div class="card-body">
							<h5 class="card-title">Operator Comment</h5>
							<p class="card-text">{{ operator_comment }}</p>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="container mt-5">
			<div class="dropdown">
				<button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
					Download
				</button>
				<ul class="dropdown-menu">
					<li><a class="dropdown-item" onclick="createNewTab()" href="#!">Chronobox Timestamps</a></li>
					<li><a class="dropdown-item" onclick="createNewTab()" href="#!">Initial ODB</a></li>
					<li><a class="dropdown-item" onclick="createNewTab()" href="#!">Sequencer Events</a></li>
					<li><a class="dropdown-item" onclick="createNewTab()" href="#!">TRG Scalers</a></li>
					<li><a class="dropdown-item" onclick="createNewTab()" href="#!">Vertices</a></li>
				</ul>
			</div>
		</div>

		<div class="container mt-5">
			<ul class="nav nav-tabs" id="commandTabs" role="tablist">
			</ul>
			<div class="tab-content" id="commandTabContent">
			</div>
		</div>

		<script>
			function loadUrl() {
				var baseUrl = window.location.origin;
				var searchInput = document.getElementById("search-input").value;
				window.location.href = baseUrl + "/" + encodeURIComponent(searchInput);
			}

			document.getElementById("load-button").addEventListener("click", loadUrl);
			document.getElementById("search-input").addEventListener("keypress",function(e) {
				if (e.key === "Enter") {
					loadUrl();
				}
			});

			let tabCounter = 1;

			function createNewTab(ws_message) {
				var tabId = 'tab-' + tabCounter;
				var tabContentId = 'content-' + tabId;

				var tabList = document.getElementById("commandTabs");
				var tabContent = document.getElementById("commandTabContent");

				var newTab = document.createElement("li");
				newTab.className = "nav-item";
				newTab.innerHTML = `
					<a class="nav-link d-flex align-items-center" id="${tabId}"	data-bs-toggle="tab" href="#${tabContentId}" role="tab">
						${tabCounter} 
						<button class="btn-close ms-2" aria-label="Close" onclick="closeTab(event, '${tabId}', '${tabContentId}')"></button>
					</a>`;
				tabList.appendChild(newTab);

				var outputId = 'output-' + tabContentId;
				var newTabContent = document.createElement("div");
				newTabContent.className = "tab-pane fade";
				newTabContent.id = tabContentId;
				newTabContent.setAttribute("role", "tabpanel");
				newTabContent.innerHTML = `<pre class="p-3 bg-light border"	id="${outputId}">Loading...</pre>`;
				tabContent.appendChild(newTabContent);

				var tabTrigger = new bootstrap.Tab(document.getElementById(`${tabId}`));
				tabTrigger.show();

				tabCounter++;

				openWebSocket(outputId, ws_message);
			}

			function closeTab(event, tabId, tabContentId) {
				event.stopPropagation();
				document.getElementById(tabId).parentElement.remove();
				document.getElementById(tabContentId).remove();
				
				var remainingTabs = document.querySelectorAll('#commandTabs .nav-link');
				if (remainingTabs.length > 0) {
					var firstTab = new bootstrap.Tab(remainingTabs[0]);
					firstTab.show();
				}
			}

			function openWebSocket(outputId, ws_message) {
				var ws = new WebSocket("ws://" + window.location.host + "/ws");

				outputElement = document.getElementById(outputId);

				ws.onopen = function() {
					outputElement.innerText = 'Connection established...\n';
					ws.send(ws_message);
				};

				ws.onmessage = function(event) {
					outputElement.innerText += event.data + '\n';
				};
				
				ws.onclose = function() {
					outputElement.innerText += 'Connection closed.\n';
				};

				ws.onerror = function(error) {
					outputElement.innerText += 'Websocket error: ' + error.message + '\n';
				};
			}
		</script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	</body>
</html>
